#set($title = "企业管理")
#set($layout = "/layout/default.vm")


##查询表单
<form class="layui-form" id="form_id_query">
    <div class="layui-row">
        <div class="layui-col-md3">
            <div class="layui-form-item">
                <label class="layui-form-label">公司名称</label>
                <div class="layui-input-block">
                    <input type="text" id="id_fullName" name="fullName" placeholder="请输入公司全称，支持模糊查询" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-col-md2">

            <div class="layui-form-item">
                <label class="layui-form-label">是否启用</label>
                <div class="layui-input-block">
                ##                    <input id="id_status" type="checkbox" name="status" lay-skin="primary" title="">
                    <select id="id_status" name="status" lay-filter="select_lf_status">
                        <option value="" selected=""></option>
                        <option value="0">否</option>
                        <option value="1">是</option>
                    </select>
                </div>
            </div>

        </div>
    </div>
    <div class="layui-row">
        <div class="layui-col-md3">
            <div class="layui-form-item">
                <label class="layui-form-label">所属城市</label>
                <div class="layui-input-block">
                    <input type="text" id="id_ownerCity" name="ownerCity"
                           placeholder="请输入公司所属城市" autocomplete="off" class="layui-input">
                </div>
            </div>
        </div>
        <div class="layui-col-md3">
            <div class="layui-form-item">
                <label class="layui-form-label">所属地区</label>
                <div class="layui-input-block">
                    <input type="text" id="id_area" name="area" placeholder="请输入公司所属地区" autocomplete="off"
                           class="layui-input">
                </div>
            </div>
        </div>
    </div>
</form>
##新增、查询、批量删除和导出
<div class="layui-row">
    <button id="btn_id_addCompany" class="layui-btn" lay-filter="addCompany">新增</button>
    <button id="btn_id_queryCompany" class="layui-btn" lay-filter="queryCompany">查询</button>
    <button id="btn_id_mulDelete" class="layui-btn" lay-filter="deleteCompanys">批量删除</button>
    <button id="btn_id_export" class="layui-btn" lay-filter="exprotExcel">导出</button>
</div>
<table id="companys_table" lay-filter="lf_companys_table"></table>
<form id="form_id_saveCompany" class="layui-form" style="display: none;">
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">公司全称<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="fullName" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">公司简称<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="shortName" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">所属城市<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="ownerCity" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">区域<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="area" lay-verify="required" placeholder="" autocomplete="off" class="layui-input"
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">配送地址<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="address" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">联系人<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="contactPerson" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">联系电话<a style="color: red;">*</a></label>
        <div class="layui-input-block">
            <input type="text" name="contactPhone" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">开始合作时间<a style="color: red;">*</a></label>
        <div class="layui-input-inline">
            <input type="text" name="cooperationStartTime" class="layui-input laydate" placeholder=""
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">截止合作时间<a style="color: red;">*</a></label>
        <div class="layui-input-inline">
            <input type="text" name="cooperationEndTime" class="layui-input laydate" placeholder=""
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="btn_lf_save">立即提交</button>
            <button id="btn_id_reset" type="reset" class="layui-btn layui-btn-primary">重置</button>
        </div>
    </div>
</form>
<form id="form_id_updateCompany" class="layui-form" style="display: none;">
    <input type="hidden" name="id">

    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">公司全称</label>
        <div class="layui-input-block">
            <input type="text" name="fullName" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">公司简称</label>
        <div class="layui-input-block">
            <input type="text" name="shortName" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">所属城市</label>
        <div class="layui-input-block">
            <input type="text" name="ownerCity" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">区域</label>
        <div class="layui-input-block">
            <input type="text" name="area" lay-verify="required" placeholder="" autocomplete="off" class="layui-input"
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">配送地址</label>
        <div class="layui-input-block">
            <input type="text" name="address" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">联系人</label>
        <div class="layui-input-block">
            <input type="text" name="contactPerson" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">联系电话</label>
        <div class="layui-input-block">
            <input type="text" name="contactPhone" lay-verify="required" placeholder="" autocomplete="off"
                   class="layui-input" style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">开始合作时间</label>
        <div class="layui-input-inline">
            <input type="text" name="cooperationStartTime" class="layui-input laydate" placeholder=""
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label" style="width: 100px;">截止合作时间</label>
        <div class="layui-input-inline">
            <input type="text" name="cooperationEndTime" class="layui-input laydate" placeholder=""
                   style="width: 300px;">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button id="btn_id_update" lay-submit class="layui-btn" lay-filter="btn_lf_update">确认修改</button>
        </div>
    </div>
</form>

<script src="/static/layui/layui.all.js"></script>
<script src="/static/js/common.js"></script>
<script type="text/html" id="oparatorBar">
    <form class="layui-form" id="form_id_toolBar">
        {{#  if(d.status == 1) {  }}
        <a lay-event="changeStatus" style="color: green;cursor: pointer;text-decoration: underline;">启用</a>&nbsp;&nbsp;
        {{#  } else {  }}
        <a lay-event="changeStatus" style="color: red;cursor: pointer;text-decoration: underline;">停用</a>&nbsp;&nbsp;
        {{#  }  }}
        <a class="layui-btn layui-btn-primary layui-btn-mini" lay-event="detail">查看</a>
        <a class="layui-btn layui-btn-mini" lay-event="edit">编辑</a>
        <a class="layui-btn layui-btn-danger layui-btn-mini" lay-event="del">删除</a>
    </form>
</script>
<script>
    // 渲染表格
    var table = layui.table;
    var cols = [[
        {checkbox: true, fixed: true}
        , {field: 'id', title: 'ID', width: 50, fixed: 'left'}
        , {field: 'gmtCreate', title: '创建时间', width: 180}
        , {field: 'gmtModified', title: '修改时间', width: 180}
        , {field: 'status', title: '状态', width: 80}
        , {field: 'fullName', title: '公司全名', width: 200}
        , {field: 'shortName', title: '公司简称', width: 150}
        , {field: 'ownerCity', title: '所属城市', width: 100}
        , {field: 'area', title: '所属区域', width: 150}
        , {field: 'address', title: '详细地址', width: 200}
        , {field: 'contactPerson', title: '联系人', width: 150}
        , {field: 'contactPhone', title: '联系电话', width: 200}
        , {field: 'cooperationStartTime', title: '开始合作时间', sort:true, width: 180}
        , {field: 'cooperationEndTime', title: '结束合作时间', sort:true, width: 180}
        , {fixed: 'right', width: 250, align: 'center', toolbar: '#oparatorBar'}
    ]];
    table.render({
        id: 'companyTable'
        , elem: '#companys_table' //指定原始表格元素选择器（推荐id选择器）
        , url: '/company/query'
        , method: 'post'
        , request: request
        , response: response
        , cols: cols
        , page: true
        , limit: 10
        , loading: true
        , even: true //开启隔行背景
    });

    // 渲染日期组件
    var laydate = layui.laydate;
    lay('.laydate').each(function () {
        laydate.render({
            elem: this
            , type: 'datetime'
            , trigger: 'click'
        });
    });

    // 查询绑定
    $('#btn_id_queryCompany').on('click', function () {
        table.reload('companyTable', {
            where: {
                fullName: $("#id_fullName").val()
                , status: $("#id_status").val()
                , ownerCity: $("#id_ownerCity").val()
                , area: $("#id_area").val()
            }
        });
    });

    // 新增绑定
    var addCompanyLayer;
    $('#btn_id_addCompany').on('click', function () {
        $("#btn_id_reset").click();
        var _html = document.getElementById('form_id_saveCompany').innerHTML;
        addCompanyLayer = layer.open({
            type: 1
            , content: $('#form_id_saveCompany')
            , area: ['500px', '620px']
            , end: function () {
                $('#form_id_saveCompany').css("display", "none");
            }
        });
    });

    // 新增表单提交
    var form = layui.form;
    form.on('submit(btn_lf_save)', function (data) {
        $.post('/company/save', data.field, function (res) {
            if (res.success) {
                layer.msg("新增成功");
                layer.close(addCompanyLayer);
                $('#btn_id_queryCompany').click();
            } else {
                layer.msg(res.msg);
            }
        }, 'json');
        return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
    });

    // 监听表格复选框选择
    var ids = new Array();
    table.on('checkbox(lf_companys_table)', function (obj) {
        //console.log(obj.checked); //当前是否选中状态
        // console.log(obj.data); //选中行的相关数据
        // console.log(obj.type); //如果触发的是全选，则为：all，如果触发的是单选，则为：one
        if (obj.type == "one") {
            var id = obj.data.id;
            if (obj.checked) {
                ids.push(id);
            } else {
                ids.splice($.inArray(id, ids), 1);
            }
        } else {
            if (obj.checked) {
                ids = [];
                // 获取所有的数据
                var allRecords = table.cache.companyTable;
                for (index in allRecords) {
                    ids.push(allRecords[index].id);
                }
            } else {
                ids = [];
            }
        }
    });

    // 批量删除绑定
    $('#btn_id_mulDelete').on('click', function () {
        if (ids.length == 0) {
            layer.msg("请选择要删除的记录", {icon: 7});
            return;
        }

        layer.confirm('确定删除吗?', {
            icon: 3, title: '提示'
        }, function (index) {
            mulDelete(ids);
            layer.close(index);
        });
    });
    function mulDelete(ids) {
        $.post("/company/mulDelete", {"ids": ids}, function (res) {
            if (res.success) {
                layer.msg(res.msg, {icon: 1});
                $('#btn_id_queryCompany').click();
            } else {
                layer.msg(res.msg, {icon: 2});
            }
        });
    }

    // 导出Excel绑定
    $('#btn_id_export').on('click', function () {
        var frame = document.getElementById("form_id_query");
        frame.action = '/company/exportCompany';
        frame.submit();
    });

    // 监听状态开关、查看、编辑和删除
    var updateCompanyLayer;// 表示编辑弹出层
    var curRowObj;// 表示操作的行对象
    table.on('tool(lf_companys_table)', function (obj) {
        curRowObj = obj;
        var data = obj.data;
        if (obj.event === 'changeStatus') {
            layer.msg(data.status);
        }else if (obj.event === 'detail') {
            layer.msg('ID：' + data.id + ' 的查看操作');
        } else if (obj.event === 'del') {
            layer.confirm('真的删除行么', function (index) {
                mulDelete([data.id]);
                layer.close(index);
            });
        } else if (obj.event === 'edit') {
            $('#form_id_updateCompany').find("[name='id']").val(data.id);
            $('#form_id_updateCompany').find("[name='fullName']").val(data.fullName);
            $('#form_id_updateCompany').find("[name='shortName']").val(data.shortName);
            $('#form_id_updateCompany').find("[name='ownerCity']").val(data.ownerCity);
            $('#form_id_updateCompany').find("[name='area']").val(data.area);
            $('#form_id_updateCompany').find("[name='address']").val(data.address);
            $('#form_id_updateCompany').find("[name='contactPerson']").val(data.contactPerson);
            $('#form_id_updateCompany').find("[name='contactPhone']").val(data.contactPhone);
            $('#form_id_updateCompany').find("[name='cooperationStartTime']").val(data.cooperationStartTime);
            $('#form_id_updateCompany').find("[name='cooperationEndTime']").val(data.cooperationEndTime);
            updateCompanyLayer = layer.open({
                type: 1
                , content: $('#form_id_updateCompany')
                , area: ['500px', '620px']
                , end: function () {
                    $('#form_id_updateCompany').css("display", "none");
                }
            });
        }
    });



    // 更新按钮绑定
    $("#btn_id_update").on("click", function () {
        form.on('submit(btn_lf_update)', function (data) {
            $.post('/company/update', data.field, function (res) {
                if (res.success) {
                    layer.msg("修改成功");
                    layer.close(updateCompanyLayer);
                    table.reload('companyTable', {});
                    curRowObj.update({
                        id: data.field.id
                        , gmtCreate: data.field.gmtCreate
                        , gmtModified: data.field.gmtModified
                        , status: data.field.status
                        , fullName: data.field.fullName
                        , shortName: data.field.shortName
                        , ownerCity: data.field.ownerCity
                        , area: data.field.area
                        , address: data.field.address
                        , contactPerson: data.field.contactPerson
                        , contactPhone: data.field.contactPhone
                        , cooperationStartTime: data.field.cooperationStartTime
                        , cooperationEndTime: data.field.cooperationEndTime
                    });
                } else {
                    layer.msg(res.msg);
                }
            }, 'json');
            return false;
        });
    })
</script>
<script type="text/babel"></script>